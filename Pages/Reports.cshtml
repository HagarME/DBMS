@page
@model dashProject.Pages.ReportsModel
@{
    ViewData["Title"] = "Reports";
}

<style>
    .chart-card {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .chart-card.highlight-filtered {
        border-color: #ffc107;
        background-color: #fffdf5;
        box-shadow: 0 8px 20px rgba(255, 193, 7, 0.15);
    }

    .chart-card.highlight-filtered h5 {
        color: #856404;
    }

    .filter-bar {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        align-items: flex-end;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-bottom: 24px;
    }

    .filter-col {
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 180px;
    }

    .form-label {
        font-weight: 700;
        font-size: 0.9rem;
        color: #555;
    }

    .form-control, .form-select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        outline: none;
    }

    .btn-apply {
        background: #ffc107;
        color: #000;
        font-weight: 700;
        padding: 10px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.2s;
    }

    .btn-apply:hover {
        background: #e0aa06;
    }

    .btn-clear {
        background: #eee;
        color: #555;
        font-weight: 600;
        padding: 10px 18px;
        border: none;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.9rem;
    }
</style>

<form method="get" class="filter-bar">
    <div class="filter-col">
        <label class="form-label">From Date</label>
        <input asp-for="FilterFrom" class="form-control" type="date" />
    </div>

    <div class="filter-col">
        <label class="form-label">To Date</label>
        <input asp-for="FilterTo" class="form-control" type="date" />
    </div>

    @if (Model.UserRole == "admin")
    {
        <div class="filter-col">
            <label class="form-label">Department</label>
            <select asp-for="FilterDeptId" asp-items="Model.Departments" class="form-select" onchange="resetMemberAndSubmit()">
                <option value="">All Departments</option>
            </select>
        </div>
    }

    @if (Model.UserRole == "admin" || Model.UserRole == "manager")
    {
        <div class="filter-col">
            <label class="form-label">Member</label>
            <select asp-for="FilterEmpSSN" asp-items="Model.Employees" class="form-select">
                <option value="">All Members</option>
            </select>
        </div>
    }

    <div style="display:flex; gap:10px;">
        <button type="submit" class="btn-apply">Apply Filters</button>
        <a href="/Reports" class="btn-clear">Clear</a>
    </div>
</form>

<script>
    function resetMemberAndSubmit() {
        // Find the member select if it exists
        const memberSelect = document.getElementById('FilterEmpSSN');
        if (memberSelect) {
            memberSelect.selectedIndex = 0; // Reset to "All Members"
        }
        // Submit the form
        const form = document.querySelector('.filter-bar');
        if (form) form.submit();
    }
</script>

<div class="charts-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap:24px;">

    <!-- Task Status -->
    <div class="chart-card @((Model.FilterDeptId.HasValue || !string.IsNullOrEmpty(Model.FilterEmpSSN)) ? "highlight-filtered" : "")">
        <h5 style="margin-bottom:15px; font-weight:800;">Task Status (Open vs Closed)</h5>
        <div style="height:320px;">
            <canvas id="chart1"></canvas>
        </div>
    </div>

    @if (Model.UserRole != "manager")
    {
        <!-- Tasks Per Department -->
        <div class="chart-card">
            <h5 style="margin-bottom:15px; font-weight:800;">Tasks Per Department</h5>
            <div style="height:320px;">
                <canvas id="chart2"></canvas>
            </div>
            @if (Model.FilterDeptId.HasValue || !string.IsNullOrEmpty(Model.FilterEmpSSN))
            {
                <p class="text-muted small mt-2 text-center" style="font-size: 0.8rem; color: #6c757d;">
                    * This chart remains global to show department comparisons.
                </p>
            }
        </div>
    }

    @if (Model.UserRole != "employee")
    {
        <!-- Request Trends -->
        <div class="chart-card @((Model.FilterDeptId.HasValue || !string.IsNullOrEmpty(Model.FilterEmpSSN)) ? "highlight-filtered" : "")">
            <h5 style="margin-bottom:15px; font-weight:800;">Request Trends (Emails vs Office)</h5>
            <div style="height:320px;">
                <canvas id="chart3"></canvas>
            </div>
        </div>
    }

    <!-- Email Processing -->
    <div class="chart-card @((Model.FilterDeptId.HasValue || !string.IsNullOrEmpty(Model.FilterEmpSSN)) ? "highlight-filtered" : "")">
        <h5 style="margin-bottom:15px; font-weight:800;">Email Processing (@Model.Chart4Label)</h5>
        <div style="height:320px;">
            <canvas id="chart4"></canvas>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // 1. Get Data from Model
            const data1 = @Html.Raw(Model.Chart1_TaskStatusJson ?? "null");
            const data2 = @Html.Raw(Model.Chart2_TasksDeptJson ?? "null");
            const data3 = @Html.Raw(Model.Chart3_RequestVolumeJson ?? "null");
            const data4 = @Html.Raw(Model.Chart4_EmailBreakdownJson ?? "null");

            // 2. Generic Render Function
            function renderChart(id, type, data) {
                const ctx = document.getElementById(id);
                if (ctx && data) {
                    new Chart(ctx, {
                        type: type,
                        data: data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index',
                            },
                            plugins: { 
                                legend: { 
                                    position: 'bottom',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20,
                                        font: { size: 12 }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                    titleColor: '#2d3436',
                                    bodyColor: '#636e72',
                                    borderColor: '#dfe6e9',
                                    borderWidth: 1,
                                    padding: 10,
                                    displayColors: true,
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) label += ': ';
                                            label += context.formattedValue;
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: type === 'line' || type === 'bar' ? {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: '#f0f0f0' },
                                    ticks: { font: { size: 11 } }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { font: { size: 11 } }
                                }
                            } : {}
                        }
                    });
                }
            }

            // 3. Render all 4
            renderChart('chart1', 'pie', data1);
            renderChart('chart2', 'bar', data2);
            renderChart('chart3', 'line', data3);
            renderChart('chart4', 'doughnut', data4);
        });
    </script>
}